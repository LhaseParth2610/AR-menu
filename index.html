<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Restaurant Menu</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            overflow: hidden; /* Prevent scrollbars */
            background-color: #000; /* Fallback background */
        }

        /* UI Container for controls and info */
        #ui-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.6) 60%, rgba(0,0,0,0) 100%);
            color: white;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: opacity 0.3s ease-in-out;
        }

        .hidden-ui {
            opacity: 0;
            pointer-events: none;
        }

        #dish-info {
            text-align: center;
            margin-bottom: 10px;
        }

        #dish-name {
            font-size: 1.4em;
            font-weight: bold;
            margin: 0 0 5px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

        #dish-description {
            font-size: 0.9em;
            max-width: 90%;
            margin: 0 auto;
            color: #f0f0f0;
        }

        #navigation-controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            max-width: 350px; /* Limit width of nav controls */
        }

        .nav-button {
            background-color: #ffffff;
            color: #333333;
            border: none;
            padding: 12px 20px;
            border-radius: 25px; /* More rounded buttons */
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .nav-button:active {
            transform: scale(0.95);
            background-color: #e0e0e0;
        }

        #loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
            display: none; /* Hidden by default */
            font-size: 1.2em;
        }

        /* Styling for the A-Frame scene to ensure it takes up the whole screen */
        a-scene {
            width: 100%;
            height: 100%;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Message Box for alerts */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200; /* Ensure it's on top of everything */
        }
        .message-box-content {
            background-color: white;
            padding: 20px 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 80%;
        }
        .message-box-content p {
            margin: 0 0 15px 0;
            color: #333;
        }
        .message-box-content button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="loading-indicator">Loading 3D Model...</div>

    <div id="ui-container" class="hidden-ui">
        <div id="dish-info">
            <h2 id="dish-name">Dish Name</h2>
            <p id="dish-description">Dish description will appear here.</p>
        </div>
        <div id="navigation-controls">
            <button id="prevButton" class="nav-button">❮ Prev</button>
            <button id="nextButton" class="nav-button">Next ❯</button>
        </div>
    </div>

    <!--
        IMPORTANT: Replace "path/to/your/targets.mind" with the actual path to your compiled image targets file.
        You can create this file using the MindAR online compiler: https://hiukim.github.io/mind-ar-js-doc/tools/compile-image-targets
    -->
    <a-scene id="ar-scene" mindar-image="imageTargetSrc: assets/targets.mind; autoStart: false; uiScanning: #scanningPermission;"
             color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights: true" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">

        <a-camera position="0 0 0" look-controls="enabled: false" wasd-controls="enabled: false"></a-camera>

        <a-assets timeout="30000">
            <!--
                IMPORTANT: Replace these with your actual .glb models.
                Get free GLB models from sites like Sketchfab (ensure proper licensing) or create your own.
                For testing, you can search for "food glb model" on Sketchfab.
                Example: A simple cube as a placeholder.
            -->
            <a-asset-item id="dish1Model" src="assets/burger.glb"></a-asset-item>
            <a-asset-item id="dish2Model" src="assets/pizza.glb"></a-asset-item>
            <a-asset-item id="dish3Model" src="assets/desert.glb"></a-asset-item>
            </a-assets>

        <a-entity id="marker" mindar-image-target="targetIndex: 0">
            <a-gltf-model id="currentDishModel" src="#dish1Model" position="0 0 0" scale="0.1 0.1 0.1" rotation="0 0 0" visible="false" animation-mixer>
            </a-gltf-model>
        </a-entity>
    </a-scene>

    <div id="scanningPermission" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); color: white; z-index: 20; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
        <h2 style="margin-bottom: 10px;">AR Menu Experience</h2>
        <img src="https://cdn.glitch.global/641a7d0a-0621-410c-983e-519f16990057/qr-scan-icon.svg?v=1716820084894" alt="Scan Icon" style="width: 80px; height: 80px; margin-bottom: 20px;">
        <p style="margin-bottom: 20px; font-size: 1.1em; max-width: 80%;">Point your camera at the table marker to begin.</p>
        <button id="startButton" style="padding: 12px 25px; font-size: 1.1em; color: #333; background-color: #fff; border: none; border-radius: 25px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">Start Scanning</button>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      const sceneEl = document.getElementById('ar-scene');
      // ... (other const declarations remain the same) ...
      const startButton = document.getElementById('startButton');

      // --- INITIALIZE START BUTTON AS DISABLED ---
      startButton.disabled = true;
      startButton.style.backgroundColor = '#ccc'; // Visually indicate it's disabled

      // ... (foodItems, showMessage, updateDishDisplay, MindAR Event Listeners, Navigation Button Listeners, Swipe Logic - all remain the same) ...

      // --- Start AR Scanning ---
      startButton.addEventListener('click', () => {
          // Check if the system is available (it should be if the button is enabled)
          if (!sceneEl.systems['mindar-image-system']) {
              showMessage("AR system is not ready. Please refresh the page.");
              // Keep button disabled or provide further instructions
              startButton.disabled = true;
              startButton.style.backgroundColor = '#ccc';
              return;
          }

          if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
              navigator.mediaDevices.getUserMedia({ video: true })
                  .then((stream) => {
                      stream.getTracks().forEach(track => track.stop()); // Stop the temporary stream
                      scanningPermissionUI.style.display = 'none';
                      try {
                          sceneEl.systems['mindar-image-system'].start(); // Start MindAR
                          console.log("AR Scanning Started by user.");
                          // NO arError listener here - the global one will handle it
                      } catch (error) {
                          console.error("Failed to start MindAR system directly:", error);
                          showMessage("Failed to start AR. Please refresh the page and check console for details.");
                          // Optionally, re-show scanning permission UI or guide user
                          scanningPermissionUI.style.display = 'flex';
                          startButton.disabled = false; // Allow another attempt
                          startButton.style.backgroundColor = '#fff';
                      }
                  })
                  .catch((err) => {
                      console.error("Camera permission denied or error:", err);
                      showMessage("Camera access is required for AR. Please enable camera permissions and refresh.");
                      scanningPermissionUI.querySelector('p').textContent = "Camera access denied. Please enable camera permissions in your browser settings and refresh the page.";
                      startButton.textContent = "Refresh Page";
                      startButton.onclick = () => window.location.reload();
                      startButton.disabled = false; // Re-enable for refresh action
                      startButton.style.backgroundColor = '#fff';
                  });
          } else {
              showMessage("Your browser does not support camera access (getUserMedia).");
              scanningPermissionUI.querySelector('p').textContent = "Your browser doesn't support the necessary features for AR.";
              startButton.style.display = 'none';
          }
      });

      // --- Initial Setup ---
      // ... (remains the same) ...

      // --- A-Frame scene loaded event ---
      sceneEl.addEventListener('loaded', () => {
          console.log('A-Frame scene and MindAR system components loaded.');
          if (sceneEl.systems['mindar-image-system']) {
              // --- ENABLE START BUTTON ONCE SCENE AND SYSTEM ARE READY ---
              startButton.disabled = false;
              startButton.style.backgroundColor = '#fff';
              console.log('MindAR system is available. Start button enabled.');
          } else {
              console.error('MindAR system not found after A-Frame scene load.');
              showMessage("A critical AR system component failed to load. Please refresh the page.");
              scanningPermissionUI.querySelector('p').textContent = "AR system failed to initialize. Please refresh.";
              startButton.textContent = "Refresh Page";
              startButton.onclick = () => window.location.reload();
              startButton.disabled = false; // Enable for refresh action
              startButton.style.backgroundColor = '#fff';
          }
      });

      // --- Global AR System Error Handler ---
      // This listener is correctly placed and should handle errors from MindAR
      sceneEl.addEventListener('arError', (event) => {
          console.error("MindAR Global Error Event:", event.detail);
          let message = "An AR error occurred.";
          if (event.detail.name === 'IMAGE_TARGETS_LOADING_ERROR' || event.detail.error === 'IMAGE_TARGETS_NOT_FOUND' || (event.detail.message && event.detail.message.includes("fetch"))) {
              message = "Could not load image targets. Please check: \n1. The path to your '.mind' file ('assets/targets.mind') is correct. \n2. The file exists at that location. \n3. The file is not corrupted. \n4. Your web server is serving the file correctly (check network tab for 404 errors).";
          } else if (event.detail.name === 'WEBCAM_ERROR' || event.detail.error === 'WEBCAM_UNAVAILABLE') {
              message = "Webcam is unavailable. Please ensure it's not in use by another application and you've granted camera permissions.";
          } else if (event.detail.message) {
              message = `AR Error: ${event.detail.message}`;
          }

          showMessage(message);
          // Show scanning UI again with error
          scanningPermissionUI.style.display = 'flex';
          scanningPermissionUI.querySelector('p').textContent = message + " Please try again or check the browser console for more details.";
          startButton.textContent = "Try Again";
          startButton.onclick = () => window.location.reload(); // Simplest recovery
          startButton.disabled = false;
          startButton.style.backgroundColor = '#fff';
      });
  });
</script>